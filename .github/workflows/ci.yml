name: CI

on: [push]

env:
  node-version: 12.x

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: prettier --version
        uses: ./
        with:
          args: --version
      - name: prettier --help
        uses: ./
        with:
          args: --help
      - name: prettier --check .
        uses: ./
        with:
          args: --check .
      - name: prettier --write .
        uses: ./
        with:
          args: --write .
  verify-output:
    name: Verify Output
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node.js ${{ env.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ env.node-version }}
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Rebuild output
        run: yarn build -o dist-ci
      - name: Verify output
        run: diff -q dist/index.js dist-ci/index.js
  release:
    # if: github.ref == 'refs/heads/master'
    needs: [test, verify-output]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node.js ${{ env.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ env.node-version }}
      - id: get-prettier-info
        name: Get Prettier info
        run: echo "::set-output name=version::$(yarn info -s prettier version)"
      - name: Create release v${{ steps.get-prettier-info.outputs.version }}
        run: echo "${{ steps.get-prettier-info.outputs.version }}"
